<!DOCTYPE html>
<html lang="en">
<head>

    <!--Coded by Naoto Isayama -->

        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-RJ8SVP1XLV"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());

            gtag('config', 'G-RJ8SVP1XLV');
        </script>

        <!--metadata-->
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="Blackthorn Tattoo Ink is a fictional tattoo company based in Edmonton, Alberta, founded by award winning artist, Emily Blackthorn">
        <meta name="format-detection" content="telephone=no"> <!--Prevents Safari Default Styling-->
    
        <!-- Social Media Tags -->
        <meta property="og:title" content="BlackThorn Tattoo">
        <meta property="og:description" content="Fictional Tattoo company in Edmonton Alberta">
        <meta property="og:image" content="[]"><!--ADD THIS WHEN HOSTING-->
        <meta property="og:url" content="[Your Website URL]"> <!--ADD THIS WHEN HOSTING-->
        
        <title>Blackthorn Tattoo Ink | Book A Appointment</title>

        <!--css-->
        <link rel="stylesheet" type="text/css" href="styles.css">

        <!--Baskerville SC-->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Baskervville+SC:wght@400..700&display=swap" rel="stylesheet">

        <!--Young Serif-->
        <link href="https://fonts.googleapis.com/css2?family=Young+Serif&display=swap" rel="stylesheet">

        <!--Fav Icon-->
        <link rel="icon" type="image/png" sizes="32x32" href="images/Vector-1.png">
        <link rel="icon" type="image/png" sizes="16x16" href="favicons/Vector.png">
        <link rel="icon" type="image/png" sizes="48x48" href="favicons/Vector-2.png">

        <!-- Flatpickr CSS -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

        <!--Lucide CDN import-->
        <script src="https://unpkg.com/lucide@latest"></script>
</head>
    <body>

        <!--MOBILE NAV-->
        <header id="mobileNav">
            <div class="mobileNav__options">
            <a id="mobileNav__logo-link" class="border-box" href="index.html">
                <img src="images/logo4.png" id="mobileNav__logo-image" alt="">
            </a>

            <label class="hamburger-menu border-box" for="hamburger-checkbox">
                <input id="hamburger-checkbox" class="hamburger-checkbox" type="checkbox">
            </label> 
            

            <!--Change nav to aside-->
            <nav class="side-menu">
                <ul class="side-menu__nav-links">
                    <li class="sc-title light"><a aria-label="Go to Gallery Page" href="portfolio.html">Portfolio</a></li>
                    <li class="sc-title light"><a aria-label="Go to Flash store Page" href="flashstore.html">Flash</a></li>
                    <li class="sc-title light"><a aria-label="Go to About Us Page" href="aftercare.html">Aftercare</a></li>
                    <li class="sc-title light"><a aria-label="Go to Contact Page" href="form.html">Book</a></li>
                </ul>
            </nav>   
            </div>
        </header>

        <nav class="nav-padding desktop-nav undo-absolute page-nav bg-dark">
            <a href="/index.html"><img id="footer-logo" src="images/logo4.png"></a>
            <a class="sc-body light" href="/portfolio.html">Portfolio</a>
            <a class="sc-body light" href="/flashstore.html">Flash</a>
            <a class="sc-body light" href="/aftercare.html">Aftercare</a>
            <a class="sc-body light" href="/form.html">Book</a>
        </nav>

        <div class="marquee form-hide-marquee">
            <div class="marquee__inner-el">
                <span class="marquee-font span1">BOOK NOW • EDMONTON • TATTOO • BOOK NOW • EDMONTON • TATTOO • BOOK NOW • EDMONTON • TATTOO • BOOK NOW • EDMONTON • TATTOO • BOOK NOW • EDMONTON • TATTOO •</span>
                <span class="marquee-font span2">BOOK NOW • EDMONTON • TATTOO • BOOK NOW • EDMONTON • TATTOO • BOOK NOW • EDMONTON • TATTOO • BOOK NOW • EDMONTON • TATTOO • BOOK NOW • EDMONTON • TATTOO •</span>
            </div>
        </div>

        <section class="contact fade-section" id="contact">
        <div class="form__flex-container">
            <div class="form__image-container">
                <img id="form-image" src="images/form-img.webp">
            </div>
            <div class="form__form-container form-padding">
                <img id="form__flowers-overlay" src="images/flowers-overlay-1.png" alt="an overlay image of flowers">
                <h2 class="sc-subtitle fade" data-speed="fast">Book an <span class="rose">appointment</span></h2>
                
                <p class="body dev-message-form" data-speed="fast"><i data-lucide="message-circle-warning" id="warning-bubble"></i>  Please note! This form has submissions disabled, since this is a public demo website. -Naoto
                </p>
                <p id="submit-message" class="submit-message sc-medium">Thanks for Reaching out! <br>(In a full version, the client will get a email confirmation, and you get a email with all the relevant info)</p>
                <form method="post">
                    <!--Name Input-->
                    <div class="form-line fade" data-speed="medium">
                        <label class="sc-medium block">Name</label>
                        <input class="sc-body" placeholder="Your Name">
                    </div>

                    <!--Phone number Input-->
                    <div class="form-line fade" data-speed="medium">
                        <label class="sc-medium block">Phone Number</label>
                        <input class="sc-body" placeholder="Your Phone Number">
                    </div>

                    <!--Email Input-->
                    <div class="form-line fade" data-speed="medium">
                        <label class="sc-medium block">Email</label>
                        <input class="sc-body" placeholder="Your Email">
                    </div>

                        <!--Tattoo Placement Dropdown Menu !!! CONSIDER REPLACEING W/ CHECKBOX-->
                        <div class="form-line fade">
                            <label class="sc-medium block" for="tattoo-location">Tattoo Placement</label>
                            <select class="sc-body" id="tattoo-location" name="tattoo-location" required>
                                <option class="sc-body" value="" disabled selected>Select placement</option>
                                <option class="sc-body" value="shoulder">Shoulder/Upper Arm</option>
                                <option class="sc-body" value="other">Forearm</option>
                                <option class="sc-body" value="other">Upper Back</option>
                            </select>
                        </div>

                    <!--Tattoo location Dropdown Menu !!! CONSIDER REPLACEING W/ CHECKBOX-->
                    <!--Currently have hardcoded values but I will need to eventually implement a dynamic way to 
                    get values  -->
                    <div class="form-line fade">
                        <label class="sc-medium block" for="tattoo-location">Your Location</label>
                        <select class="sc-body" id="tattoo-city" name="tattoo-location" required>
                            <option class="sc-body" value="" disabled selected>Select City</option>
                            <option class="sc-body" value="Edmonton">Edmonton</option>
                            <option class="sc-body" value="Vancouver">Vancouver</option>
                            <option class="sc-body" value="Montreal">Montreal</option>
                        </select>
                    </div>
                    
                    <!--Tattoo Details Input-->
                    <div class="form-line fade" data-speed="medium">
                        <label class="sc-medium block">Brief Description of your tattoo</label>
                        <textarea rows="3" class="sc-body" placeholder="I want a dragon tattoo..."></textarea>
                    </div>
                    
                    <!--Reference Photos-->
                    <div class="form-line ref-photos fade" data-speed="medium">
                        <label class="sc-medium block reference-photos-title">Reference Photos</label>
                        <label class="sc-body custom-file-upload-1" for="reference-photos1">
                            <span class="sc-body custom-file-upload__btn-text-1"> Reference Photo 1</span>
                            <input type="file" id="reference-photos1" name="reference-photos[]" accept="image/*" multiple>
                        </label>
                        <label class="sc-body custom-file-upload-2" for="reference-photos2">
                            <span class="sc-body custom-file-upload__btn-text-2">Reference Photo 2</span>
                            <input type="file" id="reference-photos2" name="reference-photos[]" accept="image/*" multiple>
                        </label>
                        <label class="sc-body custom-file-upload-3" for="reference-photos3">
                            <span class="sc-body custom-file-upload__btn-text-3">Reference Photo 3</span>
                            <input type="file" id="reference-photos3" name="reference-photos[]" accept="image/*" multiple>
                        </label>
                    </div>

                    <!--Date picker-->
                    <div class="form-line fade" data-speed="medium">
                        <label class="sc-medium block" for="appointment-date">Appointment Date (Please Read Below!)</label>
                        <!--<span class="dev-note body dark">The dates on this calendar are controlled by a private scheduling dashboard, and what the user chooses as their location above. For this example, this artist works Mon-Fri in Edmonton, and is going to Vancouver from September 22nd-26th. As well, this artist has booked appointments on Sept 29th, Oct 2nd, and Oct 8th. Switch between the two location options above to see the changes on the calendar. If you're interested in seeing how this dashboard works, shoot me an email!-Naoto</span>-->
                        <div class="date-picker" id="date-picker-el" data-id="datetime">
                            <input class="sc-body" type="text" id="appointment-date" name="appointment-date" placeholder="Select a Location First" data-input>
                            <button type="button" class="calendar-button" title="toggle" data-toggle>
                                <i data-lucide="calendar"></i>
                            </button>
                        </div>
                    </div>

                    <!--time blocks-->
                    <div class="form-line time-blocks-grid fade" data-speed="medium">
                        <label class="sc-medium block reference-photos-title">Select a time</label>
                        
                        <!--Example Time Slot Button, delete later
                        <label class="time-block borderred">
                            <input type = "radio" name="timeBlock" value="9:00-10:30">
                            9:00-10:30
                        </label>-->

                    </div>

                    <button id="submit-button" type="submit" class="button sc-medium fade" data-speed="slow">SUBMIT</button>
                </form>
            </div>
        </div>
    </section>

    <footer class="side-padding">
        <div class="footer-top">
            <img id="footer-logo" src="images/logo4_black.png">
            <span><a id="personal-link" href="https://www.naotoisayama.com">Designed By Naoto Isayama</a></span>
        </div>
        <div class="divider"></div>
        <div>
            <span class="copyright">© 2025 Blackthorn Tattoo. All rights reserved</span>
        </div>
    </footer>

    <!--scripts-->
    <script src="updateFileUpload.js"></script>
    <script src="submithandler.js"></script>
    <script src="sectionObserver.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script><!-- Flatpickr JS -->

    <script>
        window.addEventListener('DOMContentLoaded', async () => {

            /* 2025-09-27: The schema for the schedule is now an array of objects, where each object has a
            day of the week, and a time range in the 24hr format. Pretty sure this breaks my current setup*/

            lucide.createIcons(); // replaces all data-lucide icons with SVGs

            // Send POST request on page load
            const response = await fetch('https://blackthorntattoo.naotoisayama.com/.netlify/functions/getAvailability', {
                method: 'POST',
            })
            const data = await response.json();
            window.availabilityData = data;


            // 1. EXTRACT WEEKLY SCHEDULE INTO ARRAY
                // Console logs
            console.log('window.availabilityData is', window.availabilityData);

                // Console.log of weeklySchedule
            console.log('weeklyScheduleArray is', window.availabilityData.weeklySchedule);

            let weeklyScheduleArray = window.availabilityData.weeklySchedule; //Extract out the 'weeklySchedule' array for better readability
            let weeklyScheduleObject = weeklyScheduleArray[0];

            const homeCity = weeklyScheduleArray[0].homeCity; // weeklySchedule Array should just be size 1, look into adding restrictions in sanity studio
            const scheduledDaysArray = weeklyScheduleArray[0].weekdays.flatMap(s => s.day); // Get scheduled days into a flattened 1-D array

                // Console.log of weeklySchedule *check
            console.log(`Weekly Schedule Array Data is : ${scheduledDaysArray} after processing`);

                // Console.log HOMECITY
            console.log('Home City is: ', homeCity);
                



            // 2.. EXTRACT ROAD TRIP DATA INTO ARRAY
            // Currently working on implementing conditional calendar view based on user selection of
            // 'location' option
            // Console log extracted
            const roadTrips = window.availabilityData.roadTrips
            console.log('roadTrips is', roadTrips);



            // 3.. EXTRACT BLOCKED DATES INTO ARRAY
            // Console log extracted
            console.log('window.availabilityData.blockedDates is', window.availabilityData.bookedDays);

            const bookedDatesArray = window.availabilityData.bookedDays.map(b => b.date);

            console.log('The bookedDatesArray is ', bookedDatesArray);



            // 5.. IMPLEMENT LOGIC FOR LOCATION-BASED FILTERING
            let selectedValue;
            let selectedTrip;

            //init flatpickr first
            const calendarInstance = flatpickr("#date-picker-el", {
                dateFormat: "Y-m-d",
                minDate: "today",
                wrap: true,
                onChange: (selectedDates, dateStr, instance) => {
                    console.log('selectedDates[0] is: ', selectedDates[0]);
                    if (selectedDates[0]) {
                        getHours(selectedDates[0], dropdown.value);
                    }
                }
            });

            const dropdown = document.getElementById("tattoo-city");
            
            // Write function that returns 'false' if date is not in scheduledDaysArray
            // getDay() return the numerical representation of the day of the week, convert it
            // to string since 'scheduledDaysArray' consists of strings

            const recurringDisabledWeekdays = (date) => {
                return !(scheduledDaysArray.includes(date.getDay().toString()));
            }

            let today = new Date();
            let twelveMonths = new Date();
            twelveMonths.setMonth(today.getMonth() + 6);
            const grid = document.querySelector(".time-blocks-grid");

            // Dropdown menu event listener, The initialization for flatpickr is inside here
            dropdown.addEventListener("change", () => {

                // Clear calendar
                calendarInstance.clear()

                // Clear grid
                const oldBlocks = grid.querySelectorAll(".time-block");
                oldBlocks.forEach(block => block.remove());

                // Dropdown option selected
                selectedValue = dropdown.value;

                //console log
                console.log('selectedValue is: ', selectedValue);

                // If selected Value is home city, display schedule - (trip dates + bookedDays)
                // console log comparison
                /*
                console.log('The truth value of selectedValue = homeCity is: ', selectedValue === homeCity);
                console.log('The data type of selectedValue is: ', typeof selectedValue);
                console.log('The data type of homeCity is: ', typeof homeCity);*/
                
                const flatpickrArray = [];

                if (selectedValue === homeCity) {

                    // Loop through road trips, and push a range object to disable array
                    for (let i =  0; i < roadTrips.length; i++) {
                        flatpickrArray.push({
                            from: roadTrips[i].trip.startDate,
                            to: roadTrips[i].trip.endDate
                        })
                    }
                    
                    // Add booked dates array to disabled
                    for (let i = 0; i < bookedDatesArray.length; i++) {
                        flatpickrArray.push(bookedDatesArray[i]);
                    }

                    //console.log('The Disabled array, after adding trips and booked dates is: ', flatpickrArray); 

                    calendarInstance.set("disable", [...flatpickrArray, recurringDisabledWeekdays]);
                    calendarInstance.set("minDate", today);

                } else {
                    
                    let startDateObj;

                    // Find which trip is selected and disable today -> startOfTrip && endOfTrip -> 3 months
                    for (let i = 0; i < roadTrips.length; i++) {
                        if (roadTrips[i].trip.city === selectedValue) {

                            //console.log("The Start of the strip is: ", roadTrips[i].trip.startDate);
                            //console.log("The End of the strip is: ", roadTrips[i].trip.endDate);

                            // today -> startOfTrip

                            // randomly convert to dat obj
                            startDateObj = new Date(roadTrips[i].trip.startDate);

                            // from is inclusive, so go today -1
                            today.setDate(today.getDate()-1);

                            flatpickrArray.push({
                                from: today,
                                to: startDateObj
                            });

                            // endOfTrip -> 3 months
                            const endDateObj = new Date(roadTrips[i].trip.endDate);
                            endDateObj.setDate(endDateObj.getDate() + 1);

                            flatpickrArray.push({
                                from: endDateObj,
                                to: twelveMonths
                            });
                        }
                    }

                    calendarInstance.set("disable", [...flatpickrArray, ...bookedDatesArray]);
                    calendarInstance.set("minDate", startDateObj);
                }
            });


            // 6.. FROM SELECTED DATE, GET HOUR RANGE

            // Console log date range for selected day
            let city = dropdown.value;

            // timeDiff calculates the time difference between 2 24-hr strings and returns the
            // start and end times, expressed as minutes since midnight
            function timeDiff(start, end) {
                const [startHours, startMins] = start.split(":").map(Number);
                const [endHours, endMinutes] = end.split(":").map(Number);

                // Convert both to minutes since midnight
                const startDelta = startHours * 60 + startMins;
                const endDelta = endHours * 60 + endMinutes;

                // return diff, startDelta and endDelta
                return {
                    delta: endDelta - startDelta,
                    start: startDelta,
                    end: endDelta
                }
            }  
            
            // VIBE CODED. Translates minutes from midnight to 24hr xx:xx format
            function formatTimeRange(time1, time2) {
                function minutesTo24Hour(minutes) {
                    const hours = Math.floor(minutes / 60);
                    const mins = minutes % 60;
                    // pad with leading 0
                    const hh = hours.toString().padStart(2, "0");
                    const mm = mins.toString().padStart(2, "0");
                    return `${hh}:${mm}`;
                }
                return `${minutesTo24Hour(time1)}-${minutesTo24Hour(time2)}`;
            }

            // minutesToStandardTime converts 
            function minutesToStandardTime() {};

            // Get hours is a function that takes a date string (chosen by the user via flatpickr)
            // and a city (chosen by the user in the dropdown) and creates a grid of buttons, corresponding to
            // available time blocks of size n (n being the time needed to do the flash tattoo)

            function getHours(dateObj, city) {

                //clear all old blocks
                const oldBlocks = grid.querySelectorAll(".time-block");
                oldBlocks.forEach(block => block.remove());

                const dateWeekday = dateObj.getDay();
                let timeChunks = [];
                let n = 90;

                // Since the city is already selected, we can grab the schedule based on that choice
                if (city === homeCity) {
                    alert("getHours() fired, main branch");

                    // console.log("dateWeekday is: ", dateWeekday);
                    // console.log("weeklyScheduleObject is: ", weeklyScheduleObject);
                    let weekday = weeklyScheduleObject.weekdays[dateWeekday];

                    // in minutes
                    let timeDiffObj = timeDiff(weekday.startTime, weekday.endTime)

                    console.log("The time range is: ", timeDiffObj.delta, " minutes.");
                    // Here, set n to be the size (in minutes) you want the time chunks to be
                    

                    // This loop calculates how many N sized chunks fit in the available time
                    // Each object in timeChunks represents the time blocks (minutes since Midnight)
                    // that are available
                    for (let i = 0; i < (timeDiffObj.delta/n); i++) {
                        if ((n + (n * i)) <= timeDiffObj.delta) { // This conditional checks if the 'end' of the next iteration exceeds the end of the artists working hours
                            timeChunks.push({
                                start: timeDiffObj.start + (n * i),
                                end: (timeDiffObj.start + n) + (n * i)
                            })
                        }
                    }

                    // 4:46: Next step, generate a button / check box for each object in time chunk. For now, lets just insert 
                    // the minutes since midnight format.
                    timeChunks.forEach(block => {
                        //Create label
                        const label = document.createElement("label");
                        label.className = "time-block";

                        //Create radio input
                        const radioInput = document.createElement("input");
                        radioInput.type = "radio";
                        radioInput.name = "timeBlock";
                        radioInput.value = `${formatTimeRange(block.start, block.end)}`;
                        
                        //Create text span
                        const text = document.createElement("span");
                        text.textContent = `${formatTimeRange(block.start, block.end)}`;
                        
                        label.appendChild(radioInput);
                        label.appendChild(text);

                        grid.appendChild(label);
                    })
                } else {
                    // Write code for road trip city

                    // Find city name in roadTrips
                    let timeDiffObj; 

                    roadTrips.forEach(item => {
                        if (item.trip.city === city) {
                            timeDiffObj = timeDiff(item.trip.timeSlot.startTime, item.trip.timeSlot.endTime)
                            alert("City Found");
                        }
                    });

                    console.log("timeDiffObj for the road trip is: ", timeDiffObj);

                    // MAKE A HELPER FUNCTION !!!

                    // This loop calculates how many N sized chunks fit in the available time
                    // Each object in timeChunks represents the time blocks (minutes since Midnight)
                    // that are available
                    for (let i = 0; i < (timeDiffObj.delta/n); i++) {
                        if ((n + (n * i)) <= timeDiffObj.delta) { // This conditional checks if the 'end' of the next iteration exceeds the end of the artists working hours
                            timeChunks.push({
                                start: timeDiffObj.start + (n * i),
                                end: (timeDiffObj.start + n) + (n * i)
                            })
                        }
                    }

                    timeChunks.forEach(block => {
                        //Create label
                        const label = document.createElement("label");
                        label.className = "time-block";

                        //Create radio input
                        const radioInput = document.createElement("input");
                        radioInput.type = "radio";
                        radioInput.name = "timeBlock";
                        radioInput.value = `${formatTimeRange(block.start, block.end)}`;
                        
                        //Create text span
                        const text = document.createElement("span");
                        text.textContent = `${formatTimeRange(block.start, block.end)}`;
                        
                        label.appendChild(radioInput);
                        label.appendChild(text);

                        grid.appendChild(label);
                    })
                }
            }

        })           
    </script>

    </body>
</html>